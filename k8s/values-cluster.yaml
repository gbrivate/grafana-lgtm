image:
  repository: otel/opentelemetry-collector-contrib
  tag: 0.139.0
  pullPolicy: IfNotPresent

mode: deployment

presets:
  clusterMetrics:
    enabled: true
  kubernetesEvents:
    enabled: true

config:

  receivers:
    # MÃ‰TRICAS DO CLUSTER (node allocatable, pod count, namespace stats etc)
    k8s_cluster:
      collection_interval: 5s

  processors:
    transform:
      error_mode: ignore
      metric_statements:
        - context: datapoint
          statements:
            # 1. Standard Labels (Namespace & Pod)
            - set(datapoint.attributes["namespace"], resource.attributes["k8s.namespace.name"])
            - set(datapoint.attributes["pod"], resource.attributes["k8s.pod.name"])

            # 2. THE SMART LOGIC FOR DEPLOYMENT NAME

            # Step A: Try to get the actual deployment name if OTel found it
            - set(datapoint.attributes["deployment"], resource.attributes["k8s.deployment.name"])

            # Step B: If Step A failed (result is nil), grab the ReplicaSet name (e.g., "coredns-668d6bf9bc")
            - set(datapoint.attributes["deployment"], resource.attributes["k8s.replicaset.name"]) where datapoint.attributes["deployment"] == nil

            # Step C: If it's a DaemonSet, use that name instead
            - set(datapoint.attributes["deployment"], resource.attributes["k8s.daemonset.name"]) where datapoint.attributes["deployment"] == nil

            # Step D: REGEX CLEANUP
            # If the name looks like "name-hash" (ReplicaSet style), strip the last hyphen and hash.
            # Regex explanation: "-[a-f0-9]+$" means "a hyphen followed by hex characters at the end of the string"
            - replace_pattern(datapoint.attributes["deployment"], "-[a-f0-9]+$", "")

            # 3. Phase Label
            - set(datapoint.attributes["phase"], resource.attributes["k8s.pod.phase"])

            # 4. Kafka related pod/topic
            # --- Kafka Labels ---
            # Promote the Kafka Topic to a label
            #- set(datapoint.attributes["topic"], resource.attributes[label_values(kafka_topic_bytes_in_total, topic)])

            # Promote the Kafka Client ID to a label
            #- set(datapoint.attributes["client_id"], resource.attributes["kafka.client.id"]) kafka_client_messages_total

            # --- 2. Kafka/App Labels (New Logic) ---

            # Promote all new attributes to metric labels for easy querying in Prometheus
            # These attributes come directly from your application's `attrs` dictionary:
            - set(datapoint.attributes["topic"], datapoint.attributes["topic"])
            - set(datapoint.attributes["direction"], datapoint.attributes["direction"])
            - set(datapoint.attributes["group_id"], datapoint.attributes["group_id"])
            - set(datapoint.attributes["partition"], datapoint.attributes["partition"])
            - set(datapoint.attributes["status"], datapoint.attributes["status"])

              # Note: If any attribute is not present on a specific metric (e.g., 'status' is not on a consumer metric),
            # the transform processor ignores the statement, which is the desired behavior.

    batch: {}

  exporters:
    otlp/tempo:
      endpoint: "grafana-service.lgtm.svc.cluster.local:4317"
      tls:
        insecure: true

    otlphttp/loki:
      endpoint: "http://grafana-service.lgtm.svc.cluster.local:4318"
      tls:
        insecure: true

    prometheusremotewrite/prometheus:
      endpoint: "http://grafana-service.lgtm.svc.cluster.local:9090/api/v1/write"
      # Safety net to ensure resource attributes are sent as labels
      resource_to_telemetry_conversion:
        enabled: true

  service:
    pipelines:
      logs:
        receivers: [k8sobjects] # or otlp if you are sending events
        processors: [batch]
        exporters: [otlphttp/loki]

      metrics:
        # Added 'transform' to the pipeline
        receivers: [k8s_cluster]
        processors: [transform, batch]
        exporters: [prometheusremotewrite/prometheus]

clusterRole:
  create: true
  rules:
    # The Cluster Collector needs broad permissions to see everything
    - apiGroups: [""]
      resources: ["pods", "nodes", "namespaces", "replicationcontrollers", "services", "events", "endpoints", "nodes/stats"]
      verbs: ["get", "list", "watch"]
    - apiGroups: ["apps"]
      resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
      verbs: ["get", "list", "watch"]
    - apiGroups: ["batch"]
      resources: ["cronjobs", "jobs"]
      verbs: ["get", "list", "watch"]