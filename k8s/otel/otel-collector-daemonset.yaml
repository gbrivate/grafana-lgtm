apiVersion: v1
kind: Namespace
metadata:
  name: opentelemetry

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector
  namespace: opentelemetry

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-collector-k8s
rules:
  - apiGroups: [""]
    resources: ["pods", "namespaces", "nodes", "endpoints"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["nodes/proxy"]
    verbs: ["get"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["create", "get", "list", "watch", "update", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-collector-k8s-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-collector-k8s
subjects:
  - kind: ServiceAccount
    name: otel-collector
    namespace: opentelemetry

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: opentelemetry
data:
  config.yaml: |
    receivers:
      filelog:
        include:
          - /var/log/containers/*_corban_*.log
        start_at: beginning
        include_file_path: true
        include_file_name: false
        max_concurrent_files: 100
        poll_interval: 200ms

      otlp:
        protocols:
          grpc:
          http:

    processors:
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.container.name
            - k8s.node.name
            - container.id
          labels:
            - key: app
            - key: app.kubernetes.io/name

      attributes/service-name:
        actions:
          - action: insert
            key: service.name
            from_attribute: k8s.labels["app.kubernetes.io/name"]

          - action: insert
            key: service.name
            from_attribute: k8s.labels["app"]

          - action: upsert
            key: service.name
            from_attribute: k8s.container.name

      batch: {}

      memory_limiter:
        check_interval: 1s
        limit_percentage: 75
        spike_limit_percentage: 10

    exporters:
      otlphttp:
        endpoint: "http://grafana-service.lgtm.svc.cluster.local:4318"
        tls:
          insecure: true

      debug: {}

    service:
      pipelines:
        logs:
          receivers: [filelog]
          processors: [k8sattributes, attributes/service-name, batch]
          exporters: [otlphttp]

        traces:
          receivers: [otlp]
          processors: [k8sattributes, attributes/service-name, batch]
          exporters: [otlphttp]

        metrics:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [otlphttp]
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
  namespace: opentelemetry
  labels:
    app: otel-collector
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      serviceAccountName: otel-collector
      tolerations:
        - operator: Exists
      priorityClassName: system-node-critical
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector-contrib:0.139.0
          imagePullPolicy: Always
          args: ["--config=/etc/otel/config.yaml"]
          resources:
            requests:
              cpu: 100m
              memory: 200Mi
            limits:
              cpu: 500m
              memory: 1Gi
          volumeMounts:
            - name: config
              mountPath: /etc/otel
            - name: varlog
              mountPath: /var/log
              readOnly: true
            - name: containers
              mountPath: /var/lib/docker/containers
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: otel-collector-config
        - name: varlog
          hostPath:
            path: /var/log
        - name: containers
          hostPath:
            path: /var/lib/docker/containers
